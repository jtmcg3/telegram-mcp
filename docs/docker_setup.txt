# Dockerfile
FROM python:3.11-slim AS base

FROM base AS builder

# Copy uv binary from the official image
COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/uv

# Enable bytecode compilation and use copy mode for Docker
ENV UV_COMPILE_BYTECODE=1 UV_LINK_MODE=copy

WORKDIR /app

# Copy only dependency files first for better caching
COPY pyproject.toml /app/

# Create virtual environment and install dependencies
RUN uv venv && \
    uv pip install fastmcp>=0.1.0 python-telegram-bot>=21.0 python-dotenv>=1.0.0 requests>=2.31.0

# Copy application code
COPY telegram_mcp_server.py .
COPY config/ ./config/

# Create non-root user for security
RUN useradd -m -u 1000 mcpuser && chown -R mcpuser:mcpuser /app
USER mcpuser

# Expose MCP port (if needed for debugging)
EXPOSE 8080

# Run the server
CMD ["python", "telegram_mcp_server.py"]

---

# Dependencies are managed in pyproject.toml
# No separate requirements.txt needed with UV

---

# docker-compose.yml
version: '3.8'

services:
  telegram-mcp:
    build: .
    container_name: telegram-mcp-server
    restart: unless-stopped
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - LOG_LEVEL=INFO
    volumes:
      - ./data:/app/data  # Persist conversation history if needed
      - ./logs:/app/logs  # Persist logs
    networks:
      - mcp-network
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8080/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  mcp-network:
    driver: bridge

volumes:
  mcp-data:
  mcp-logs:

---

# .env (create this file with your actual values)
TELEGRAM_BOT_TOKEN=your_bot_token_here
TELEGRAM_CHAT_ID=your_chat_id_here

---

# docker-run.sh (helper script)
#!/bin/bash

# Load environment variables
if [ -f .env ]; then
    export $(cat .env | xargs)
fi

# Validate required environment variables
if [ -z "$TELEGRAM_BOT_TOKEN" ]; then
    echo "Error: TELEGRAM_BOT_TOKEN not set"
    exit 1
fi

if [ -z "$TELEGRAM_CHAT_ID" ]; then
    echo "Error: TELEGRAM_CHAT_ID not set"
    exit 1
fi

# Build and run the container
docker-compose up --build -d

echo "Telegram MCP Server started!"
echo "Check logs with: docker-compose logs -f telegram-mcp"

---

# get_chat_id.py (utility script)
#!/usr/bin/env python3
"""
Utility script to get your Telegram chat ID
Run this after creating your bot and sending it a message
"""
import os
import requests
from dotenv import load_dotenv

load_dotenv()

def get_chat_id():
    token = os.getenv('TELEGRAM_BOT_TOKEN')
    if not token:
        print("Error: TELEGRAM_BOT_TOKEN not found in environment")
        print("Make sure you have a .env file with your bot token")
        return
    
    url = f"https://api.telegram.org/bot{token}/getUpdates"
    
    print("Getting updates from Telegram...")
    response = requests.get(url)
    
    if response.status_code == 200:
        data = response.json()
        
        if data['result']:
            for update in data['result']:
                chat = update['message']['chat']
                print(f"Chat ID: {chat['id']}")
                print(f"Chat Type: {chat['type']}")
                if 'username' in chat:
                    print(f"Username: @{chat['username']}")
                if 'first_name' in chat:
                    print(f"Name: {chat['first_name']}")
                print("-" * 30)
        else:
            print("No messages found. Send a message to your bot first!")
    else:
        print(f"Error: {response.status_code}")
        print(response.text)

if __name__ == "__main__":
    get_chat_id()